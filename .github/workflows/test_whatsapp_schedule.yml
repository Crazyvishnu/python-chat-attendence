name: WhatsApp Cron Combined Test

on:
  schedule:
    - cron: '*/5 * * * *'   # every 5 minutes (UTC)
  workflow_dispatch: {}

jobs:
  send-test-message:
    runs-on: ubuntu-latest
    steps:
      - name: Show run start time (UTC)
        run: |
          echo "Run start (UTC):"
          date -u
          echo "----"

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install twilio pytz

      - name: Send WhatsApp confirmation via Twilio (and print debug)
        env:
          MY_PHONE_NUMBER: ${{ secrets.MY_PHONE_NUMBER }}
          TWILIO_PHONE_NUMBER: ${{ secrets.TWILIO_PHONE_NUMBER }}
          TWILIO_SID: ${{ secrets.TWILIO_SID }}
          TWILIO_TOKEN: ${{ secrets.TWILIO_TOKEN }}
        run: |
          python - <<'PY'
          import os, sys
          from datetime import datetime
          import pytz
          from twilio.rest import Client
          try:
              to_num = os.environ.get("MY_PHONE_NUMBER")
              from_num = os.environ.get("TWILIO_PHONE_NUMBER")
              sid = os.environ.get("TWILIO_SID")
              token = os.environ.get("TWILIO_TOKEN")
              print("Env check:", bool(to_num), bool(from_num), bool(sid), bool(token))
              if not all([to_num, from_num, sid, token]):
                  print("Missing one of the required environment variables.", file=sys.stderr)
                  sys.exit(2)
              ist = pytz.timezone("Asia/Kolkata")
              now = datetime.now(ist).strftime("%d-%b-%Y %I:%M %p")
              client = Client(sid, token)
              body = f"âœ… GitHub Cron Test:\nWorkflow ran at {now} (IST)"
              print("Attempting to send to", to_num)
              msg = client.messages.create(body=body, from_=f"whatsapp:{from_num}", to=f"whatsapp:{to_num}")
              print("SENT_SID:", msg.sid)
          except Exception as e:
              print("TWILIO ERROR:", type(e).__name__, str(e), file=sys.stderr)
              raise
          PY
