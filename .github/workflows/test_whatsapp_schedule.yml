name: WhatsApp Cron Test (Every 5 Minutes)

on:
  schedule:
    - cron: '*/5 * * * *'   # every 5 minutes (UTC)
  workflow_dispatch: {}

jobs:
  send-test-message:
    runs-on: ubuntu-latest
    steps:
      - name: Install Python & Twilio
        run: |
          python -m pip install --upgrade pip
          pip install twilio pytz

      - name: Send WhatsApp confirmation via Twilio
        env:
          MY_PHONE_NUMBER: ${{ secrets.MY_PHONE_NUMBER }}
          TWILIO_PHONE_NUMBER: ${{ secrets.TWILIO_PHONE_NUMBER }}
          TWILIO_SID: ${{ secrets.TWILIO_SID }}
          TWILIO_TOKEN: ${{ secrets.TWILIO_TOKEN }}
        run: |
          python <<'PYCODE'
          from datetime import datetime
          import pytz, os
          from twilio.rest import Client

          ist = pytz.timezone("Asia/Kolkata")
          now = datetime.now(ist).strftime("%d-%b-%Y %I:%M %p")

          sid = os.environ["TWILIO_SID"]
          token = os.environ["TWILIO_TOKEN"]
          client = Client(sid, token)

          body = f"âœ… GitHub Cron Test:\nWorkflow ran successfully at {now} (IST)"
          msg = client.messages.create(
              body=body,
              from_=f"whatsapp:{os.environ['TWILIO_PHONE_NUMBER']}",
              to=f"whatsapp:{os.environ['MY_PHONE_NUMBER']}"
          )
          print("SENT_SID:", msg.sid)
          PYCODE
